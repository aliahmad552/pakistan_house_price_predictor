<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pakistan House Price Predictor ‚Äî AI</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <meta name="description" content="AI-powered web app to predict house prices in Pakistan based on city, location, and property details." />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!-- HEADER -->
  <header class="site-header">
    <div class="container header-inner">
      <div class="logo-section">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="logo">
        <div>
          <h1>Pakistan House Price Predictor</h1>
          <p class="tagline">AI-Powered Real Estate Insights</p>
        </div>
      </div>
      <button id="helpBtn" class="btn-outline">How it Works</button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container main-grid">
    <!-- FORM -->
    <section class="card form-section fade-in">
      <h2>üè† Predict Property Price</h2>
      <p class="text-muted">Fill in property details to get an AI-generated estimated price.</p>

      <form id="predictForm" method="POST" action="/">
        <div class="form-group">
          <label>Purpose</label>
          <div class="radio-group">
            <label><input type="radio" name="model_type" value="sale" checked> For Sale</label>
            <label><input type="radio" name="model_type" value="rent"> For Rent</label>
          </div>
        </div>

        <div class="form-group">
          <label>City</label>
          <select id="city" name="city" required>
            <option value="" disabled selected>Select City</option>
            {% for c in cities %}
              <option value="{{ c }}" {% if city == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label>Location</label>
          <select id="location" name="location" required>
            {% if location %}
              <option value="{{ location }}">{{ location }}</option>
            {% else %}
              <option value="" disabled selected>Choose city first</option>
            {% endif %}
          </select>
        </div>

        <div class="form-group">
          <label>Property Type</label>
          <select id="property_type" name="property_type" required>
            <option value="" disabled selected>Select Property Type</option>
            {% for p in property_types %}
              <option value="{{ p }}" {% if property_type == p %}selected{% endif %}>{{ p }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="grid-two">
          <div class="form-group">
            <label>Bedrooms</label>
            <input type="number" id="bedrooms" name="bedrooms" min="0" step="1" value="{{ bedrooms or 1 }}" required>
          </div>
          <div class="form-group">
            <label>Baths</label>
            <input type="number" id="baths" name="baths" min="0" step="1" value="{{ baths or 1 }}" required>
          </div>
        </div>

        <div class="form-group">
          <label>Area (in Marla)</label>
          <input type="number" id="area" name="area" step="0.01" min="0.01" value="{{ area or '' }}" placeholder="e.g., 5.25" required>
        </div>

        <div class="button-row">
          <button type="submit" class="btn-primary">Predict</button>
          <button type="button" id="resetBtn" class="btn-outline">Reset</button>
        </div>
      </form>
    </section>

    <!-- RESULTS -->
    <section class="card result-section fade-in">
      {% if prediction %}
      <h2>üí∞ Predicted Price</h2>
      <p class="predicted-value">Rs <span>{{ prediction }}</span></p>

      <div class="details-grid">
        <p><strong>City:</strong> {{ city }}</p>
        <p><strong>Location:</strong> {{ location }}</p>
        <p><strong>Property Type:</strong> {{ property_type }}</p>
        <p><strong>Bedrooms:</strong> {{ bedrooms }}</p>
        <p><strong>Baths:</strong> {{ baths }}</p>
        <p><strong>Area:</strong> {{ area }} Marla</p>
        <p><strong>Purpose:</strong> {{ model_type|capitalize }}</p>
      </div>

      {% if avg_price %}
      <hr>
      <h3>üìä Local Market Insights</h3>
      <p><strong>Average Price:</strong> Rs {{ avg_price|int }}</p>
      <p><strong>Range:</strong> Rs {{ min_price|int }} ‚Äì Rs {{ max_price|int }}</p>
      <p><strong>Total Listings:</strong> {{ total_listings }}</p>

      <div class="chart-container">
        <canvas id="priceChart" height="200"></canvas>
      </div>
      {% endif %}

      <div class="button-row">
        <a href="#" class="btn-primary" onclick="window.print();return false;">Print</a>
        <a href="/" class="btn-outline">New Prediction</a>
      </div>

      {% else %}
      <div class="placeholder">
        <h3>No Prediction Yet</h3>
        <p class="text-muted">Complete the form to see AI-generated results.</p>
      </div>
      {% endif %}
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="container">
      <p>Built with ‚ù§Ô∏è by <strong>Ali Ahmad</strong> ‚Äî Data Scientist & AI Engineer</p>
    </div>
  </footer>

  <script>
    const citySelect = document.getElementById('city');
    const locationSelect = document.getElementById('location');
    const resetBtn = document.getElementById('resetBtn');
    const helpBtn = document.getElementById('helpBtn');

    async function loadLocations(city) {
      locationSelect.innerHTML = '<option>Loading...</option>';
      const res = await fetch('/get_locations/' + encodeURIComponent(city));
      const data = await res.json();
      locationSelect.innerHTML = '<option value="" disabled selected>Select Location</option>';
      data.locations.forEach(loc => {
        const opt = document.createElement('option');
        opt.value = loc;
        opt.textContent = loc;
        locationSelect.appendChild(opt);
      });
    }

    citySelect?.addEventListener('change', (e) => loadLocations(e.target.value));
    resetBtn?.addEventListener('click', () => {
      document.getElementById('predictForm').reset();
      locationSelect.innerHTML = '<option value="" disabled selected>Choose city first</option>';
    });

    helpBtn?.addEventListener('click', () => {
      alert("This AI model predicts estimated property prices in Pakistan based on selected city, location, and property features.");
    });

    // --- Chart.js Updated: Use Location Names on X-axis ---
    {% if price_distribution and location_labels %}
    const ctx = document.getElementById('priceChart');
    const prices = {{ price_distribution | tojson }};
    const labels = {{ location_labels | tojson }};
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Prices (Rs)',
          data: prices,
          backgroundColor: 'rgba(46, 125, 255, 0.6)',
          borderColor: '#2e7dff',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#333', font: { size: 12 } } },
          y: { beginAtZero: true }
        }
      }
    });
    {% endif %}
  </script>
</body>
</html>
